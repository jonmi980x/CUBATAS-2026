import firebase_admin
from firebase_admin import credentials, db
from datetime import datetime
import json

class BebidasFirebase2026:
    def __init__(self, ruta_credenciales):
        """
        Inicializa la conexiÃ³n con Firebase
        ruta_credenciales: ruta al archivo JSON de credenciales de Firebase
        """
        # Inicializar Firebase
        if not firebase_admin._apps:
            cred = credentials.Certificate(ruta_credenciales)
            firebase_admin.initialize_app(cred, {
                'databaseURL': 'https://TU-PROYECTO.firebaseio.com'
            })
        
        self.db = db.reference()
        
        self.participantes = [
            "Jonmi", "Marce", "Lucho", "Diego", "Markitos",
            "Boveda", "Bipo", "Ferrer", "Wichi", "Rabu", "Llorden"
        ]
        
        self.bebidas = {
            "cubata": {"emoji": "ğŸ¹", "puntos": 5},
            "chupito": {"emoji": "ğŸ¥ƒ", "puntos": 3},
            "cerveza": {"emoji": "ğŸº", "puntos": 1}
        }
        
        self.inicializar_estructura()
    
    def inicializar_estructura(self):
        """Crea la estructura inicial en Firebase si no existe"""
        ano_actual = datetime.now().year
        
        # Inicializar contador de salidas si no existe
        if not self.db.child(f'salidas/{ano_actual}').get():
            self.db.child(f'salidas/{ano_actual}').set({
                'total': 0,
                'historico': {}
            })
        
        # Inicializar datos de participantes
        for persona in self.participantes:
            if not self.db.child(f'participantes/{persona}').get():
                self.db.child(f'participantes/{persona}').set({
                    'nombre': persona,
                    'total_historico': {
                        'cubata': 0,
                        'chupito': 0,
                        'cerveza': 0
                    }
                })
    
    def registrar_salida(self, fecha=None):
        """Registra una nueva salida"""
        if fecha is None:
            fecha = datetime.now()
        
        ano = fecha.year
        mes = fecha.month
        dia = fecha.strftime("%Y-%m-%d")
        
        # Incrementar contador total
        salidas_ref = self.db.child(f'salidas/{ano}')
        total_actual = salidas_ref.child('total').get() or 0
        salidas_ref.child('total').set(total_actual + 1)
        
        # Registrar en histÃ³rico
        salidas_ref.child(f'historico/{dia}').set({
            'fecha': fecha.strftime("%Y-%m-%d %H:%M:%S"),
            'numero': total_actual + 1
        })
        
        print(f"ğŸ‰ Â¡Salida #{total_actual + 1} registrada! ({fecha.strftime('%d/%m/%Y')})")
        return total_actual + 1
    
    def agregar_bebida(self, persona, tipo_bebida, cantidad=1, fecha=None):
        """Registra bebidas con fecha"""
        if fecha is None:
            fecha = datetime.now()
        
        if persona not in self.participantes or tipo_bebida not in self.bebidas:
            print("âŒ Persona o bebida no vÃ¡lida")
            return False
        
        ano = fecha.year
        mes = f"{fecha.year}-{fecha.month:02d}"
        timestamp = fecha.strftime("%Y-%m-%d %H:%M:%S")
        
        # Estructura: bebidas/AÃ‘O/MES/PERSONA/TIPO_BEBIDA
        ruta_mes = f'bebidas/{ano}/{mes}/{persona}'
        
        # Obtener cantidad actual del mes
        cantidad_actual = self.db.child(f'{ruta_mes}/{tipo_bebida}').get() or 0
        nueva_cantidad = cantidad_actual + cantidad
        
        # Actualizar cantidad del mes
        self.db.child(f'{ruta_mes}/{tipo_bebida}').set(nueva_cantidad)
        
        # Actualizar total histÃ³rico
        ruta_historico = f'participantes/{persona}/total_historico/{tipo_bebida}'
        total_historico = self.db.child(ruta_historico).get() or 0
        self.db.child(ruta_historico).set(total_historico + cantidad)
        
        # Registrar en histÃ³rico detallado
        self.db.child(f'historico_detallado/{ano}/{mes}/{persona}').push({
            'tipo': tipo_bebida,
            'cantidad': cantidad,
            'timestamp': timestamp,
            'puntos': cantidad * self.bebidas[tipo_bebida]['puntos']
        })
        
        emoji = self.bebidas[tipo_bebida]["emoji"]
        puntos = self.bebidas[tipo_bebida]["puntos"] * cantidad
        print(f"âœ… +{cantidad} {emoji} para {persona} (+{puntos} pts) - {mes}")
        
        return True
    
    def quitar_bebida(self, persona, tipo_bebida, cantidad=1, fecha=None):
        """Quita bebidas (correcciÃ³n de errores)"""
        if fecha is None:
            fecha = datetime.now()
        
        if persona not in self.participantes or tipo_bebida not in self.bebidas:
            print("âŒ Persona o bebida no vÃ¡lida")
            return False
        
        ano = fecha.year
        mes = f"{fecha.year}-{fecha.month:02d}"
        ruta_mes = f'bebidas/{ano}/{mes}/{persona}'
        
        # Verificar cantidad actual
        cantidad_actual = self.db.child(f'{ruta_mes}/{tipo_bebida}').get() or 0
        
        if cantidad_actual < cantidad:
            print(f"âŒ {persona} solo tiene {cantidad_actual} {tipo_bebida}(s) en {mes}")
            return False
        
        nueva_cantidad = cantidad_actual - cantidad
        self.db.child(f'{ruta_mes}/{tipo_bebida}').set(nueva_cantidad)
        
        # Actualizar total histÃ³rico
        ruta_historico = f'participantes/{persona}/total_historico/{tipo_bebida}'
        total_historico = self.db.child(ruta_historico).get() or 0
        self.db.child(ruta_historico).set(max(0, total_historico - cantidad))
        
        emoji = self.bebidas[tipo_bebida]["emoji"]
        puntos = self.bebidas[tipo_bebida]["puntos"] * cantidad
        print(f"âš ï¸ -{cantidad} {emoji} para {persona} (-{puntos} pts) - {mes}")
        
        return True
    
    def calcular_puntos_mes(self, persona, ano, mes):
        """Calcula los puntos de una persona en un mes especÃ­fico"""
        ruta = f'bebidas/{ano}/{mes}/{persona}'
        datos = self.db.child(ruta).get() or {}
        
        total = 0
        for tipo_bebida, cantidad in datos.items():
            if tipo_bebida in self.bebidas:
                total += cantidad * self.bebidas[tipo_bebida]['puntos']
        
        return total
    
    def obtener_datos_mes(self, persona, ano, mes):
        """Obtiene los datos de bebidas de una persona en un mes"""
        ruta = f'bebidas/{ano}/{mes}/{persona}'
        datos = self.db.child(ruta).get() or {}
        
        return {
            'cubata': datos.get('cubata', 0),
            'chupito': datos.get('chupito', 0),
            'cerveza': datos.get('cerveza', 0)
        }
    
    def ranking_mes(self, ano=None, mes=None):
        """Muestra el ranking de un mes especÃ­fico"""
        if ano is None:
            ano = datetime.now().year
        if mes is None:
            mes = datetime.now().month
        
        mes_str = f"{ano}-{mes:02d}"
        
        print(f"\n{'='*70}")
        print(f"ğŸ† RANKING {self._nombre_mes(mes).upper()} {ano} ğŸ†".center(70))
        print(f"{'='*70}")
        
        # Calcular puntos de cada persona
        ranking_data = []
        for persona in self.participantes:
            puntos = self.calcular_puntos_mes(persona, ano, mes_str)
            datos = self.obtener_datos_mes(persona, ano, mes_str)
            ranking_data.append((persona, puntos, datos))
        
        # Ordenar por puntos
        ranking_data.sort(key=lambda x: x[1], reverse=True)
        
        for pos, (persona, puntos, datos) in enumerate(ranking_data, 1):
            if puntos > 0:
                medalla = self._obtener_medalla(pos)
                print(f"{medalla} {pos}. {persona}: {puntos} pts")
                print(f"    ğŸ¹ {datos['cubata']} | ğŸ¥ƒ {datos['chupito']} | ğŸº {datos['cerveza']}")
        
        print(f"{'='*70}\n")
    
    def ranking_general_ano(self, ano=None):
        """Ranking general de todo el aÃ±o"""
        if ano is None:
            ano = datetime.now().year
        
        print(f"\n{'='*70}")
        print(f"ğŸ† RANKING GENERAL {ano} ğŸ†".center(70))
        print(f"{'='*70}")
        
        ranking_data = []
        
        for persona in self.participantes:
            total_puntos = 0
            total_bebidas = {'cubata': 0, 'chupito': 0, 'cerveza': 0}
            
            # Sumar todos los meses
            bebidas_ano = self.db.child(f'bebidas/{ano}').get() or {}
            
            for mes, datos_mes in bebidas_ano.items():
                if persona in datos_mes:
                    for tipo_bebida, cantidad in datos_mes[persona].items():
                        if tipo_bebida in self.bebidas:
                            total_bebidas[tipo_bebida] += cantidad
                            total_puntos += cantidad * self.bebidas[tipo_bebida]['puntos']
            
            ranking_data.append((persona, total_puntos, total_bebidas))
        
        ranking_data.sort(key=lambda x: x[1], reverse=True)
        
        for pos, (persona, puntos, datos) in enumerate(ranking_data, 1):
            medalla = self._obtener_medalla(pos)
            print(f"{medalla} {pos}. {persona}: {puntos} pts")
            print(f"    ğŸ¹ {datos['cubata']} | ğŸ¥ƒ {datos['chupito']} | ğŸº {datos['cerveza']}")
        
        print(f"{'='*70}\n")
    
    def historico_persona(self, persona, ano=None):
        """Muestra el histÃ³rico mensual de una persona"""
        if ano is None:
            ano = datetime.now().year
        
        print(f"\n{'='*70}")
        print(f"ğŸ“Š HISTÃ“RICO {persona.upper()} - {ano} ğŸ“Š".center(70))
        print(f"{'='*70}")
        
        bebidas_ano = self.db.child(f'bebidas/{ano}').get() or {}
        
        total_anual = {'cubata': 0, 'chupito': 0, 'cerveza': 0, 'puntos': 0}
        
        for mes_num in range(1, 13):
            mes_str = f"{ano}-{mes_num:02d}"
            
            if mes_str in bebidas_ano and persona in bebidas_ano[mes_str]:
                datos = bebidas_ano[mes_str][persona]
                puntos = sum(datos.get(tipo, 0) * self.bebidas[tipo]['puntos'] 
                           for tipo in self.bebidas.keys())
                
                print(f"\nğŸ“… {self._nombre_mes(mes_num)}:")
                print(f"   ğŸ¹ Cubatas: {datos.get('cubata', 0)}")
                print(f"   ğŸ¥ƒ Chupitos: {datos.get('chupito', 0)}")
                print(f"   ğŸº Cervezas: {datos.get('cerveza', 0)}")
                print(f"   ğŸ¯ Puntos: {puntos}")
                
                for tipo in self.bebidas.keys():
                    total_anual[tipo] += datos.get(tipo, 0)
                total_anual['puntos'] += puntos
        
        print(f"\n{'â”€'*70}")
        print(f"ğŸ“ˆ TOTAL {ano}:")
        print(f"   ğŸ¹ Total Cubatas: {total_anual['cubata']}")
        print(f"   ğŸ¥ƒ Total Chupitos: {total_anual['chupito']}")
        print(f"   ğŸº Total Cervezas: {total_anual['cerveza']}")
        print(f"   ğŸ¯ TOTAL PUNTOS: {total_anual['puntos']}")
        print(f"{'='*70}\n")
    
    def comparativa_meses(self, ano=None):
        """Muestra una comparativa de todos los meses"""
        if ano is None:
            ano = datetime.now().year
        
        print(f"\n{'='*90}")
        print(f"ğŸ“Š COMPARATIVA MENSUAL {ano} ğŸ“Š".center(90))
        print(f"{'='*90}")
        
        bebidas_ano = self.db.child(f'bebidas/{ano}').get() or {}
        
        for mes_num in range(1, 13):
            mes_str = f"{ano}-{mes_num:02d}"
            
            if mes_str in bebidas_ano:
                print(f"\nğŸ—“ï¸  {self._nombre_mes(mes_num).upper()}")
                print(f"{'â”€'*90}")
                
                # Calcular totales del mes
                totales = {'cubata': 0, 'chupito': 0, 'cerveza': 0}
                
                for persona in self.participantes:
                    if persona in bebidas_ano[mes_str]:
                        datos = bebidas_ano[mes_str][persona]
                        for tipo in self.bebidas.keys():
                            totales[tipo] += datos.get(tipo, 0)
                
                print(f"ğŸ¹ Cubatas: {totales['cubata']} | ğŸ¥ƒ Chupitos: {totales['chupito']} | ğŸº Cervezas: {totales['cerveza']}")
                print(f"ğŸ» Total bebidas: {sum(totales.values())}")
        
        print(f"{'='*90}\n")
    
    def contador_salidas(self, ano=None):
        """Muestra el contador de salidas del aÃ±o"""
        if ano is None:
            ano = datetime.now().year
        
        salidas_data = self.db.child(f'salidas/{ano}').get()
        
        if not salidas_data:
            print(f"âŒ No hay salidas registradas en {ano}")
            return
        
        total = salidas_data.get('total', 0)
        historico = salidas_data.get('historico', {})
        
        print(f"\n{'='*70}")
        print(f"ğŸ‰ CONTADOR DE SALIDAS {ano} ğŸ‰".center(70))
        print(f"{'='*70}")
        print(f"\nğŸ» Total de salidas: {total}\n")
        
        if historico:
            print("ğŸ“… HistÃ³rico de salidas:")
            for fecha, datos in sorted(historico.items(), reverse=True)[:10]:
                print(f"   â€¢ {datos['fecha']} - Salida #{datos['numero']}")
        
        print(f"{'='*70}\n")
    
    def _nombre_mes(self, mes):
        """Convierte nÃºmero de mes a nombre"""
        meses = {
            1: "Enero", 2: "Febrero", 3: "Marzo", 4: "Abril",
            5: "Mayo", 6: "Junio", 7: "Julio", 8: "Agosto",
            9: "Septiembre", 10: "Octubre", 11: "Noviembre", 12: "Diciembre"
        }
        return meses.get(mes, "")
    
    def _obtener_medalla(self, posicion):
        """Retorna emoji de medalla segÃºn posiciÃ³n"""
        medallas = {1: "ğŸ¥‡", 2: "ğŸ¥ˆ", 3: "ğŸ¥‰"}
        return medallas.get(posicion, f"{posicion}.")


# MENÃš INTERACTIVO
def menu_principal():
    print("ğŸ”¥ Inicializando conexiÃ³n con Firebase...")
    print("ğŸ“ Coloca tu archivo de credenciales en la misma carpeta")
    
    ruta_credenciales = input("Ruta al archivo de credenciales (ej: credenciales.json): ").strip()
    
    try:
        sistema = BebidasFirebase2026(ruta_credenciales)
        print("âœ… ConexiÃ³n exitosa con Firebase!\n")
    except Exception as e:
        print(f"âŒ Error al conectar con Firebase: {e}")
        return
    
    while True:
        print("\n" + "ğŸ»"*30)
        print("ğŸ‰ SISTEMA DE BEBIDAS 2026 - FIREBASE ğŸ‰".center(60))
        print("ğŸ»"*30)
        print("\nğŸ“Š GESTIÃ“N DE BEBIDAS")
        print("1. â• AÃ±adir bebida")
        print("2. â– Quitar bebida")
        print("3. ğŸ‰ Registrar salida")
        
        print("\nğŸ† RANKINGS")
        print("4. ğŸ“… Ver ranking del mes actual")
        print("5. ğŸ“† Ver ranking de un mes especÃ­fico")
        print("6. ğŸ… Ver ranking general del aÃ±o")
        print("7. ğŸ¹ Ranking por tipo de bebida (mes actual)")
        
        print("\nğŸ“Š HISTÃ“RICOS Y ESTADÃSTICAS")
        print("8. ğŸ‘¤ Ver histÃ³rico de una persona")
        print("9. ğŸ“ˆ Ver comparativa mensual")
        print("10. ğŸŠ Ver contador de salidas")
        
        print("\n11. ğŸšª Salir")
        
        opcion = input("\nğŸ‘‰ Elige una opciÃ³n: ").strip()
        
        if opcion == "1":
            print("\nğŸ“‹ PERSONAS:")
            for i, p in enumerate(sistema.participantes, 1):
                print(f"{i}. {p}")
            
            try:
                persona_num = int(input("\nÂ¿QuiÃ©n bebiÃ³? (nÃºmero): "))
                persona = sistema.participantes[persona_num - 1]
                
                print("\nğŸ¹ 1. Cubata (5 pts)")
                print("ğŸ¥ƒ 2. Chupito (3 pts)")
                print("ğŸº 3. Cerveza (1 pt)")
                
                bebida_num = input("Â¿QuÃ© bebiÃ³? (nÃºmero): ").strip()
                bebidas_map = {"1": "cubata", "2": "chupito", "3": "cerveza"}
                tipo_bebida = bebidas_map.get(bebida_num)
                
                cantidad = int(input("Â¿CuÃ¡ntas? (por defecto 1): ") or "1")
                
                sistema.agregar_bebida(persona, tipo_bebida, cantidad)
            except (ValueError, IndexError):
                print("âŒ OpciÃ³n no vÃ¡lida")
        
        elif opcion == "2":
            print("\nğŸ“‹ PERSONAS:")
            for i, p in enumerate(sistema.participantes, 1):
                print(f"{i}. {p}")
            
            try:
                persona_num = int(input("\nÂ¿A quiÃ©n corregir? (nÃºmero): "))
                persona = sistema.participantes[persona_num - 1]
                
                print("\nğŸ¹ 1. Cubata")
                print("ğŸ¥ƒ 2. Chupito")
                print("ğŸº 3. Cerveza")
                
                bebida_num = input("Â¿QuÃ© bebida quitar? (nÃºmero): ").strip()
                bebidas_map = {"1": "cubata", "2": "chupito", "3": "cerveza"}
                tipo_bebida = bebidas_map.get(bebida_num)
                
                cantidad = int(input("Â¿CuÃ¡ntas quitar? (por defecto 1): ") or "1")
                
                sistema.quitar_bebida(persona, tipo_bebida, cantidad)
            except (ValueError, IndexError):
                print("âŒ OpciÃ³n no vÃ¡lida")
        
        elif opcion == "3":
            sistema.registrar_salida()
        
        elif opcion == "4":
            sistema.ranking_mes()
        
        elif opcion == "5":
            try:
                ano = int(input("AÃ±o (ej: 2026): ") or datetime.now().year)
                mes = int(input("Mes (1-12): "))
                sistema.ranking_mes(ano, mes)
            except ValueError:
                print("âŒ AÃ±o o mes no vÃ¡lido")
        
        elif opcion == "6":
            ano = int(input("AÃ±o (por defecto 2026): ") or 2026)
            sistema.ranking_general_ano(ano)
        
        elif opcion == "7":
            print("\nğŸ¹ 1. Ranking de Cubatas")
            print("ğŸ¥ƒ 2. Ranking de Chupitos")
            print("ğŸº 3. Ranking de Cervezas")
            
            tipo_num = input("Â¿QuÃ© ranking ver? (nÃºmero): ").strip()
            tipos_map = {"1": "cubata", "2": "chupito", "3": "cerveza"}
            
            # Implementar ranking por tipo...
            print("(FunciÃ³n a implementar)")
        
        elif opcion == "8":
            print("\nğŸ“‹ PERSONAS:")
            for i, p in enumerate(sistema.participantes, 1):
                print(f"{i}. {p}")
            
            try:
                persona_num = int(input("\nÂ¿De quiÃ©n ver el histÃ³rico? (nÃºmero): "))
                persona = sistema.participantes[persona_num - 1]
                sistema.historico_persona(persona)
            except (ValueError, IndexError):
                print("âŒ OpciÃ³n no vÃ¡lida")
        
        elif opcion == "9":
            sistema.comparativa_meses()
        
        elif opcion == "10":
            sistema.contador_salidas()
        
        elif opcion == "11":
            print("\nğŸ‘‹ Â¡Hasta luego! ğŸ»")
            break
        
        else:
            print("âŒ OpciÃ³n no vÃ¡lida")


if __name__ == "__main__":
    menu_principal()


